<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>ELN Notebook Viewer Host</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        background: #0f172a;
      }

      iframe {
        border: none;
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <iframe
      id="lite-frame"
      title="Embedded JupyterLite"
      src="/eln/lite/lab/index.html?kernel=python&theme=JupyterLab%20Dark"
      allow="clipboard-read; clipboard-write"
    ></iframe>
    <script>
      const liteFrame = document.getElementById("lite-frame");
      let liteWindow = null;
      const PYODIDE_KERNEL_NAME = "python";

      liteFrame.addEventListener("load", () => {
        liteWindow = liteFrame.contentWindow;
        window.parent.postMessage({ type: "eln-lite-ready" }, window.location.origin);
      });

      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      async function waitForApp() {
        const attemptStart = Date.now();
        while (Date.now() - attemptStart < 20000) {
          if (liteWindow && liteWindow.jupyterapp) {
            try {
              await liteWindow.jupyterapp.started;
              return liteWindow.jupyterapp;
            } catch (error) {
              console.warn("Waiting for JupyterLite app", error);
            }
          }
          await sleep(250);
        }
        throw new Error("Timed out waiting for JupyterLite to start");
      }

      async function openNotebook(payload) {
        const { entryId, versionNumber, content } = payload;
        const filename = `${entryId}-v${versionNumber}.ipynb`;

        try {
          const app = await waitForApp();
          const contents = app.serviceManager.contents;
          await contents.save(filename, {
            type: "notebook",
            format: "json",
            content
          });
          const widget = await app.commands.execute("docmanager:open", {
            path: filename,
            factory: "Notebook",
            kernel: { name: PYODIDE_KERNEL_NAME }
          });
          const sessionContext = widget?.context?.sessionContext;
          await ensurePyodideKernel(sessionContext);
          await waitForKernelIdle(sessionContext);
          window.parent.postMessage(
            { type: "eln-lite-opened", entryId, versionNumber },
            window.location.origin
          );
        } catch (error) {
          console.error("Failed to open notebook in JupyterLite", error);
          window.parent.postMessage(
            {
              type: "eln-lite-error",
              entryId,
              versionNumber,
              message:
                error instanceof Error ? error.message : "Unknown JupyterLite error"
            },
            window.location.origin
          );
        }
      }

      async function ensurePyodideKernel(sessionContext) {
        if (!sessionContext) {
          return;
        }
        try {
          await sessionContext.initialize();
          let kernelName =
            sessionContext.session?.kernel?.name ??
            sessionContext.session?.kernel?.model?.name ??
            null;
          if (kernelName !== PYODIDE_KERNEL_NAME) {
            await sessionContext.changeKernel({ name: PYODIDE_KERNEL_NAME });
          }
          await sessionContext.ready;
        } catch (error) {
          console.warn("Failed to enforce Pyodide kernel", error);
        }
      }

      async function waitForKernelIdle(sessionContext) {
        if (!sessionContext) {
          return;
        }
        const start = Date.now();
        while (Date.now() - start < 20000) {
          const kernel = sessionContext.session?.kernel ?? null;
          if (kernel && kernel.status === "idle") {
            return;
          }
          await sleep(200);
        }
        console.warn("Pyodide kernel did not reach idle state before timeout");
      }

      window.addEventListener("message", (event) => {
        if (event.origin !== window.location.origin) {
          return;
        }
        const data = event.data;
        if (!data || typeof data !== "object") {
          return;
        }
        if (data.type === "eln-open-notebook") {
          openNotebook(data);
        }
      });
    </script>
  </body>
</html>
